http:
  middlewares:
    # --- AUTHENTICATION ---
    auth-authentik: # Authentification via Authentik 
      forwardAuth:
        address: https://proxy-authentik:9443/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        tls:
          insecureSkipVerify: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-entitlements
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

    # --- SECURITY (IP / NETWORK) ---
    # Use depth: 1 if the Front passes the real IP, 
    # but for strict isolation between two proxies, depth 0 is safer.

    sec-allow-front-waf-only: # only allows traffic coming from edge WAFs
      ipAllowList:
        sourceRange: 
          - "0.0.0.0/32" # bunkerweb-home
        ipStrategy: { depth: 0 }

    sec-allow-front-proxy-only: # only allows traffic from the central proxy
      ipAllowList:
        sourceRange: 
          - "0.0.0.0/32" # traefik-central
        # -"0.0.0.0/32" # traefik-central-failover
        ipStrategy: { depth: 0 }

    sec-allow-prometheus-only: # only allows prometheus traffic
      ipAllowList:
        sourceRange: ["0.0.0.0/32"]
        ipStrategy: { depth: 0 }

    # --- UTILITY ---
    # To manage micro-cuts
    util-retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # --- CHAIN ---
    # Standard middleware chain for central proxy traffic
    chain-back-standard:
      chain:
        middlewares:
          - sec-allow-front-proxy-only
          - util-retry

    chain-back-waf: # Standard middleware chain for WAF traffic
      chain:
        middlewares:
          - sec-allow-front-waf-only
          - util-retry

    chain-back-auth: # Standard middleware chain for authenticated traffic via central proxy
      chain:
        middlewares:
          - sec-allow-front-proxy-only
          - auth-authentik
          - util-retry

    chain-back-auth-waf: # Standard middleware chain for traffic authenticated via WAF
      chain:
        middlewares:
          - sec-allow-front-waf-only
          - auth-authentik
          - util-retry